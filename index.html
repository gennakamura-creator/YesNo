<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>レセスタ 導入前チェック</title>
  <style>
    :root { --bg:#f7f7f8; --card:#fff; --border:#e3e3e7; --text:#111; --muted:#666; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .stage { min-height: 100vh; }
    .content {
      padding: 22px 18px 140px; /* 下段ボタン分の余白 */
      display: flex;
      justify-content: center;
      align-items: flex-start; /* 上寄り */
    }
    .wrap { width: min(880px, 100%); }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin: 6px 2px 10px;
      color: var(--muted);
      font-size: 13px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px 16px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.05);
    }
    .title {
      margin: 0 0 10px;
      font-size: 20px;
      line-height: 1.35;
    }
    .detail {
      margin: 0;
      line-height: 1.65;
      white-space: pre-wrap;
    }
    .note {
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.55;
    }
    .footerBar {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 12px 14px 18px;
      background: rgba(247,247,248,0.92);
      backdrop-filter: blur(8px);
      border-top: 1px solid var(--border);
    }
    .footerInner {
      width: min(880px, 100%);
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    button {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 14px;
      padding: 14px 12px;
      font-size: 16px;
      font-weight: 650;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
    }
    button:hover { filter: brightness(0.98); }
    button:active { transform: translateY(1px); }

    .secondaryRow {
      width: min(880px, 100%);
      margin: 10px auto 0;
      display: flex;
      gap: 10px;
    }
    .secondaryRow button {
      font-weight: 600;
      font-size: 14px;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: none;
      flex: 1;
    }

    .hidden { display: none !important; }
    .error {
      margin-top: 10px;
      color: #b00020;
      font-size: 13px;
      white-space: pre-wrap;
    }
    @media (max-width: 900px) {
      .footerInner { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="stage">
    <div class="content">
      <div class="wrap">
        <div class="header">
          <div>↓＝Yes ／ →＝No</div>
          <div>現在: <span id="nodeId">-</span></div>
        </div>

        <div class="card">
          <h1 id="qTitle" class="title"></h1>
          <p id="qDetail" class="detail"></p>
          <div id="qNote" class="note"></div>
          <div id="err" class="error"></div>
        </div>
      </div>
    </div>

    <!-- 下段固定ボタン -->
    <div class="footerBar">
      <div class="footerInner">
        <button id="yesBtn">Yes（↓）</button>
        <button id="noBtn">No（→）</button>
      </div>

      <div class="secondaryRow">
        <button id="nextBtn" class="hidden">次へ</button>
        <button id="restartBtn" class="hidden">最初から</button>
        <button id="backBtn">ひとつ戻る</button>
      </div>
    </div>
  </div>

<script>
  const FLOW = {
    startId: "q1",
    nodes: {
      q1: {
        id: "q1",
        type: "question",
        text:
`レセスタの推奨環境のPCはありますか？
【推奨環境】
・最新OS
・電カル・レセコン同居不可
・その他 推奨環境に準拠`,
        yesTo: "q2",
        noTo: "m1_no"
      },

      m1_no: {
        id: "m1_no",
        type: "outcome",
        text:
`推奨環境のPCを用意して次にお進みください
（推奨環境のPCをご用意後、最初からやり直してください）`
      },

      q2: {
        id: "q2",
        type: "question",
        text: `利用予定の端末はインターネットに接続されていますか？`,
        yesTo: "q3",
        noTo: "m2_no"
      },

      m2_no: {
        id: "m2_no",
        type: "outcome",
        text:
`インターネット環境を整えてください
（整ったら最初からやり直してください）`
      },

      q3: {
        id: "q3",
        type: "question",
        text: `電子カルテ・レセコンと同居して使用しますか？`,
        yesTo: "m3_yes",
        noTo: "q4"
      },

      m3_yes: {
        id: "m3_yes",
        type: "outcome",
        text:
`同居利用の注意点
電カル：ホワイトリスト対応
レセコン：オンライン請求端末は推奨しておりません
別端末でのご利用を推奨しております
ご使用の場合は証明書の選択誤りにご注意ください`
      },

      q4: {
        id: "q4",
        type: "question",
        text:
`レセスタではメール登録が必要ですが、メールアドレスはありますか？
【注意】
・携帯キャリアのメールは不可です
・Yahoo / Google などは利用できます
【例】XXX@docomo… / xxx@ezweb…`,
        yesTo: "q5",
        noTo: "m4_no"
      },

      m4_no: {
        id: "m4_no",
        type: "outcome",
        text:
`携帯ではないメールアドレスを作成してください
（作成後、最初からやり直してください）`
      },

      q5: {
        id: "q5",
        type: "question",
        text: `使用予定の端末でそのメールを確認できますか？`,
        yesTo: "q6",
        noTo: "m5_no"
      },

      m5_no: {
        id: "m5_no",
        type: "outcome",
        text:
`メール受信のお願い
レセスタより「タイトル」のメールが届きますので、
添付ファイルを解凍して使用する端末に移動してください。

可能ならレセスタを使用するPCでメール受信できるよう
設定してください`
      },

      q6: {
        id: "q6",
        type: "outcome",
        text:
`お疲れ様でした（導入前チェック完了）
（導入フローへ進む場合は案内をご確認ください）`
      },

      q7: {
        id: "q7",
        type: "outcome",
        text:
`導入・運用開始のご案内
レセスタは縦覧点検に対応しています。
レセプト提出時のレセプトデータ（点検用）を
過去6ヶ月分程度ご準備ください。`
      }
    }
  };

  // outcomeを見せたあとに「次へ」で進む先（あなたの意図を反映）
  const OUTCOME_NEXT = {
    m3_yes: "q4",
    m5_no: "q6",
    q6: "q7"
  };

  const $ = (id) => document.getElementById(id);

  const nodeIdEl = $("nodeId");
  const qTitleEl = $("qTitle");
  const qDetailEl = $("qDetail");
  const qNoteEl = $("qNote");
  const errEl = $("err");

  const yesBtn = $("yesBtn");
  const noBtn = $("noBtn");
  const nextBtn = $("nextBtn");
  const restartBtn = $("restartBtn");
  const backBtn = $("backBtn");

  const historyStack = [];
  let currentId = FLOW.startId;

  function getNode(id) { return FLOW.nodes[id] || null; }

  function validateFlowOnce() {
    const errors = [];
    if (!FLOW.startId || !getNode(FLOW.startId)) errors.push(`startId "${FLOW.startId}" が存在しません`);
    for (const [id, n] of Object.entries(FLOW.nodes)) {
      if (!n.text) errors.push(`"${id}" の text が空です`);
      if (n.type === "question") {
        if (!n.yesTo || !getNode(n.yesTo)) errors.push(`"${id}" の yesTo が不正（${n.yesTo}）`);
        if (!n.noTo  || !getNode(n.noTo))  errors.push(`"${id}" の noTo が不正（${n.noTo}）`);
      }
    }
    return errors;
  }

  function splitText(text) {
    const lines = String(text || "").split("\n");
    const title = (lines.shift() || "").trim();
    const detail = lines.join("\n").trim();
    return { title, detail };
  }

  function setFooterMode(mode, hasNext=false) {
    // mode: "question" | "outcome"
    if (mode === "question") {
      yesBtn.classList.remove("hidden");
      noBtn.classList.remove("hidden");
      nextBtn.classList.add("hidden");
      restartBtn.classList.add("hidden");
    } else {
      yesBtn.classList.add("hidden");
      noBtn.classList.add("hidden");
      if (hasNext) {
        nextBtn.classList.remove("hidden");
        restartBtn.classList.add("hidden");
      } else {
        nextBtn.classList.add("hidden");
        restartBtn.classList.remove("hidden");
      }
    }
  }

  function showNode(id, pushHistory = true) {
    const n = getNode(id);
    if (!n) {
      errEl.textContent = `ノードが見つかりません: ${id}`;
      return;
    }
    errEl.textContent = "";

    if (pushHistory && currentId) historyStack.push(currentId);
    currentId = id;

    nodeIdEl.textContent = id;

    const { title, detail } = splitText(n.text);
    qTitleEl.textContent = title || "（無題）";
    qDetailEl.textContent = detail;

    if (n.type === "question") {
      setFooterMode("question");
      qNoteEl.textContent = "下の Yes / No を選択してください。";
    } else {
      const next = OUTCOME_NEXT[id];
      setFooterMode("outcome", !!next);
      qNoteEl.textContent = next
        ? "内容を確認したら「次へ」で進んでください。"
        : "「最初から」で再実行できます。";
    }
  }

  function jump(nextId) { showNode(nextId, true); }

  yesBtn.addEventListener("click", () => {
    const n = getNode(currentId);
    if (!n || n.type !== "question") return;
    jump(n.yesTo);
  });

  noBtn.addEventListener("click", () => {
    const n = getNode(currentId);
    if (!n || n.type !== "question") return;
    jump(n.noTo);
  });

  nextBtn.addEventListener("click", () => {
    const next = OUTCOME_NEXT[currentId];
    if (!next) return;
    jump(next);
  });

  restartBtn.addEventListener("click", () => {
    historyStack.length = 0;
    showNode(FLOW.startId, false);
  });

  backBtn.addEventListener("click", () => {
    const prev = historyStack.pop();
    if (!prev) return;
    showNode(prev, false);
  });

  const errs = validateFlowOnce();
  if (errs.length) errEl.textContent = "設定エラー:\n" + errs.join("\n");

  showNode(FLOW.startId, false);
</script>
</body>
</html>
